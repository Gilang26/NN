<script>
function sanitizeExecutors(input) {
  // dukung banyak executor dipisah koma, auto-potong 20-byte & checksum
  return input.split(",").map(s => s.trim())
    .filter(Boolean)
    .map(s => {
      let r = s.toLowerCase().replace(/[^0-9a-fx]/g, "");
      if (!r.startsWith("0x")) r = "0x" + r;
      if (r.length > 42) r = r.slice(0, 42);     // auto-truncate ke 20-byte
      return ethers.utils.getAddress(r);         // checksum & validasi
    });
}

async function redeemNow(){
  try{
    if(!window.sender32 || !window.payload) return log("‚ö†Ô∏è Build dulu sebelum redeem.");

    const SRC_EID = 30101;
    const list = sanitizeExecutors(document.getElementById("executor").value);

    if(!/^0x[0-9a-fA-F]{64}$/.test(window.sender32)) return log("‚ö†Ô∏è sender32 harus 32-byte hex.");
    if(!/^0x[0-9a-fA-F]+$/.test(window.payload))     return log("‚ö†Ô∏è payload tidak valid (hex).");

    const ABI4 = ["function lzReceive(uint32,bytes32,bytes,address) external"];
    const ABI3 = ["function lzReceive(uint32,bytes32,bytes) external"];

    for (const exec of list){
      try{
        log(`üöÄ Coba v4 @ ${exec}`);
        const c4 = new ethers.Contract(exec, ABI4, signer);
        const tx = await c4.lzReceive(SRC_EID, window.sender32, window.payload, exec, { gasLimit: 600000 });
        log(`‚è≥ TX: ${tx.hash}`);
        const rc = await tx.wait();
        log(`‚úÖ Delivered v4 di block ${rc.blockNumber} via ${exec}`);
        return;
      }catch(e1){
        log(`‚ö†Ô∏è v4 gagal @ ${exec}, coba v3...`);
        try{
          const c3 = new ethers.Contract(exec, ABI3, signer);
          const tx2 = await c3.lzReceive(SRC_EID, window.sender32, window.payload, { gasLimit: 600000 });
          log(`‚è≥ TX: ${tx2.hash}`);
          const rc2 = await tx2.wait();
          log(`‚úÖ Delivered v3 di block ${rc2.blockNumber} via ${exec}`);
          return;
        }catch(e2){
          log(`‚ùå Gagal @ ${exec}: ${(e2.data?.message||e2.message||e2)}`);
        }
      }
    }
    log("‚ùå Semua executor gagal. Coba executor lain atau tunggu relayer resmi.");
  }catch(e){
    log("‚ùå Redeem error: " + (e.data?.message || e.message || e));
  }
}
</script>
