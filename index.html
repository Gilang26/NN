<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LayerZero Redeem v2.6 (Hybrid Auto-Fetch JSON)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
body {
  font-family: "Poppins", sans-serif;
  background: #f6fff8;
  color: #111;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  margin: 0;
}
.card {
  background: #fff;
  border: 1px solid #c8e3ce;
  border-radius: 16px;
  padding: 24px;
  width: min(480px, 90vw);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}
h2 {
  color: #22c55e;
  text-align: center;
  margin-top: 0;
}
input,
button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 10px;
  font-size: 15px;
}
input {
  border: 1px solid #b9e1c2;
  background: #ecf8ed;
  color: #111;
}
button {
  cursor: pointer;
  font-weight: 700;
  border: 0;
  transition: 0.2s;
}
button.primary {
  background: linear-gradient(90deg, #34d058, #22c55e);
  color: #fff;
}
pre {
  background: #ecf8ed;
  border: 1px solid #b9e1c2;
  border-radius: 10px;
  padding: 10px;
  margin-top: 14px;
  font-size: 13px;
  white-space: pre-wrap;
  max-height: 300px;
  overflow: auto;
}
footer {
  margin-top: 25px;
  color: #666;
  font-size: 14px;
}
</style>
</head>
<body>
<div class="card">
  <h2>üîÅ LayerZero Redeem (v2.6)</h2>
  <input id="txhash" placeholder="Masukkan LayerZero TX hash (0x...)" />
  <input id="srcEid" value="30101" placeholder="srcEid (contoh: 30101)" />
  <input id="executor" value="0xab329959fe048721cdf7f13a3eb43e4fc549a9de1adb90d393701583c4b11f79" placeholder="Executor (hash panjang atau address)" />
  <input id="sender32" placeholder="sender32 (otomatis)" />
  <input id="payload" placeholder="payload (otomatis)" />
  <button id="connect" class="primary">üîå Connect Wallet</button>
  <button id="fetch" class="primary">üõ∞Ô∏è Auto Fetch Payload</button>
  <button id="redeem" class="primary">üöÄ Redeem Sekarang</button>
  <pre id="log">log siap...</pre>
</div>
<footer>by thdx</footer>

<script>
const log = (m)=>{const el=document.getElementById("log");el.textContent+=(el.textContent?"\n":"")+m;el.scrollTop=el.scrollHeight;console.log(m);}
const LZ_ABI4=["function lzReceive(uint32,bytes32,bytes,address) external"];
const LZ_ABI3=["function lzReceive(uint32,bytes32,bytes) external"];
let provider,signer,me;

function $(id){return document.getElementById(id);}

async function connect(){
  try{
    provider=new ethers.providers.Web3Provider(window.ethereum,"any");
    await provider.send("eth_requestAccounts",[]);
    signer=provider.getSigner();
    me=await signer.getAddress();
    const n=await provider.getNetwork();
    log(`‚úÖ Connected: ${me}\nChain: ${n.chainId}`);
  }catch(e){log("‚ùå Connect error: "+(e.message||e));}
}

async function fetchLZ(){
  try{
    const tx=$("txhash").value.trim();
    if(!/^0x[0-9a-fA-F]{64}$/.test(tx)) return log("‚ö†Ô∏è TX hash tidak valid.");
    log("‚è≥ Fetching LayerZeroScan JSON...");

    // Try JSON API first
    const urls=[
      `https://api.testnet.layerzeroscan.com/api/tx/${tx}`,
      `https://testnet.layerzeroscan.com/api/tx/${tx}`,
      `https://api-testnet.layerzeroscan.com/api/tx/${tx}`
    ];
    let data=null;
    for(const u of urls){
      try{
        const r=await fetch(u);
        if(r.ok){data=await r.json();if(data)break;}
      }catch{}
    }

    if(data && data.payload){
      $("sender32").value=data.srcUaAddress || data.srcUa || "";
      $("payload").value=data.payload;
      log(`‚úÖ JSON found!`);
      log(`üë§ sender32: ${$("sender32").value}`);
      log(`üì¶ payload: ${$("payload").value.slice(0,66)}...`);
      try{
        const [to,amt]=ethers.utils.defaultAbiCoder.decode(["address","uint256"],data.payload);
        log(`üß™ Decoded ‚Üí to=${to}, amount=${ethers.utils.formatUnits(amt,6)}`);
      }catch{}
      return;
    }

    // fallback HTML scraping
    log("‚ö†Ô∏è JSON API tidak ada data, fallback HTML...");
    const res=await fetch(`https://testnet.layerzeroscan.com/tx/${tx}`);
    const html=await res.text();
    const hexes=html.match(/0x[0-9a-fA-F]{64,}/g)||[];
    const uniq=[...new Set(hexes)];
    const sender=uniq.find(x=>x.length===66);
    const payload=uniq.find(x=>x.length>66&&x.length%2===0);
    if(sender){$("sender32").value=sender;log(`üë§ sender32: ${sender}`);} else log("‚ö†Ô∏è sender32 tidak ditemukan");
    if(payload){
      $("payload").value=payload;
      log(`üì¶ payload: ${payload.slice(0,60)}...`);
      try{
        const [to,amt]=ethers.utils.defaultAbiCoder.decode(["address","uint256"],payload);
        log(`üß™ Decoded ‚Üí to=${to}, amount=${ethers.utils.formatUnits(amt,6)}`);
      }catch{}
    } else log("‚ö†Ô∏è payload tidak ditemukan");
  }catch(e){log("‚ùå Fetch error: "+(e.message||e));}
}

async function redeem(){
  try{
    const srcEid=Number($("srcEid").value.trim()||30101);
    let execRaw=$("executor").value.trim().toLowerCase().replace(/[^0-9a-fx]/g,"");
    if(execRaw.length>42){
      const shortened=execRaw.slice(0,42);
      log(`‚ÑπÔ∏è Executor dipotong otomatis ke: ${shortened}`);
      execRaw=shortened;
    }
    const exec=ethers.utils.getAddress(execRaw);
    const sender=$("sender32").value.trim();
    const payload=$("payload").value.trim();

    if(!/^0x[0-9a-fA-F]{64}$/.test(sender)) return log("‚ö†Ô∏è sender32 harus 32-byte hex.");
    if(!/^0x[0-9a-fA-F]+$/.test(payload)) return log("‚ö†Ô∏è payload tidak valid (hex).");

    const c4=new ethers.Contract(exec,LZ_ABI4,signer);
    const c3=new ethers.Contract(exec,LZ_ABI3,signer);

    try{
      log(`üöÄ Coba lzReceive v4 @ ${exec}`);
      const tx=await c4.lzReceive(srcEid,sender,payload,exec,{gasLimit:600000});
      log(`‚è≥ TX: ${tx.hash}`);
      const rc=await tx.wait();
      log(`‚úÖ Redeem sukses di block ${rc.blockNumber}`);
    }catch(err1){
      log("‚ö†Ô∏è Versi v4 gagal, mencoba fallback v3...");
      const tx2=await c3.lzReceive(srcEid,sender,payload,{gasLimit:600000});
      log(`‚è≥ TX: ${tx2.hash}`);
      const rc2=await tx2.wait();
      log(`‚úÖ Redeem v3 sukses di block ${rc2.blockNumber}`);
    }
  }catch(e){log("‚ùå Redeem error: "+(e.data?.message||e.message||e));}
}

document.getElementById("connect").onclick=connect;
document.getElementById("fetch").onclick=fetchLZ;
document.getElementById("redeem").onclick=redeem;
</script>
</body>
</html>
