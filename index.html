<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bridge Testnet Stable</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
:root {
  --bg:#f5fff7; --card:#ffffff; --mut:#cde6d3; --fld:#ecf8ed; 
  --acc:#34c759; --ok:#22c55e; --warn:#facc15;
}
body { margin:0; background:var(--bg); font-family:"Poppins",sans-serif; color:#111; display:flex; flex-direction:column; align-items:center; }
header { display:flex; align-items:center; gap:10px; padding:14px 20px; width:100%; box-shadow:0 1px 4px rgba(0,0,0,.05); background:#fff; }
header img { height:30px; }
h1 { margin:0; font-size:18px; font-weight:600; color:#111; }
.tabs { margin-top:20px; display:flex; gap:10px; }
.tab { background:#fff; border:1px solid var(--mut); border-radius:8px; padding:8px 18px; cursor:pointer; font-weight:600; }
.tab.active { background:var(--acc); color:#fff; border-color:var(--acc); }
.card { width:min(480px,90vw); background:var(--card); border:1px solid var(--mut); border-radius:16px; padding:22px; box-shadow:0 4px 10px rgba(0,0,0,.08); margin-top:20px; }
input,button { width:100%; padding:12px; margin-top:8px; border-radius:10px; font-size:15px; }
input { border:1px solid var(--mut); background:var(--fld); }
button { border:0; font-weight:700; cursor:pointer; transition:.2s; }
button.primary { background:linear-gradient(90deg,#34d058,#28a745); color:#fff; }
button.ok { background:linear-gradient(90deg,#22c55e,#16a34a); color:#fff; }
pre { background:var(--fld); border:1px solid var(--mut); border-radius:10px; padding:10px; margin-top:12px; font-size:13px; white-space:pre-wrap; }
footer { margin:30px 0 10px; color:#6b6b6b; font-size:14px; }
</style>
</head>
<body>

<header>
  <img src="https://seeklogo.com/images/L/layerzero-logo-73E416FD9B-seeklogo.com.png" alt="LayerZero Logo">
  <h1>Bridge Testnet Stable</h1>
</header>

<div class="tabs">
  <div class="tab active" id="tabBridge">ğŸŒ‰ Bridge</div>
  <div class="tab" id="tabRedeem">ğŸ” Redeem</div>
</div>

<div class="card" id="bridgeCard">
  <h2>ğŸŒ‰ Bridge USDT0 â†’ Stable</h2>
  <input id="amount" type="number" placeholder="Jumlah token (misal 10)" />
  <button id="connectBridge" class="primary">ğŸ”Œ Connect Wallet</button>
  <button id="approve" class="primary" disabled>âœ… Approve</button>
  <button id="bridge" class="ok" disabled>ğŸš€ Bridge Now</button>
  <pre id="logBridge">log siap...</pre>
</div>

<div class="card" id="redeemCard" style="display:none">
  <h2>ğŸ” Manual Redeem (LayerZero)</h2>
  <input id="srcEid" value="30101" placeholder="srcEid (Sepolia)" />
  <input id="executor" value="0xab329959fe048721cdf7f13a3eb43e4fc549a9de1adb90d393701583c4b11f79" />
  <input id="sender32" value="0x000000000000000000000000cc1ae8cf5d3904cef3360a9532b477529b177cce" />
  <input id="payload" value="0x0000000000000000000000004d02af17a29cda77416a1f60eae9092bb6d9c02600038d7ea4c68000" />
  <button id="connectRedeem" class="primary">ğŸ”Œ Connect Wallet</button>
  <button id="redeem" class="ok">ğŸš€ Send lzReceive()</button>
  <pre id="logRedeem">log siap...</pre>
</div>

<footer>by thdx</footer>

<script>
const tabBridge=document.getElementById("tabBridge");
const tabRedeem=document.getElementById("tabRedeem");
const bridgeCard=document.getElementById("bridgeCard");
const redeemCard=document.getElementById("redeemCard");

tabBridge.onclick=()=>{tabBridge.classList.add("active");tabRedeem.classList.remove("active");bridgeCard.style.display="block";redeemCard.style.display="none";}
tabRedeem.onclick=()=>{tabRedeem.classList.add("active");tabBridge.classList.remove("active");bridgeCard.style.display="none";redeemCard.style.display="block";}

/* BRIDGE */
(function loadEthers(){
  if(typeof window.ethers==="undefined"){
    const s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js";
    s.onload=initBridge;
    document.body.appendChild(s);
  }else initBridge();
})();
function initBridge(){
  const log=m=>{const el=document.getElementById("logBridge");el.textContent+=(el.textContent?"\n":"")+m;el.scrollTop=el.scrollHeight;}
  const ERC20_ABI=["function approve(address,uint256) returns(bool)"];
  const OFT_ABI=[
    "function quoteSend((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),bool)view returns(uint256 nativeFee,uint256 zroFee)",
    "function send((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),(uint256,uint256),address)payable"
  ];
  const adapter="0xc099cD946d5efCC35A99D64E808c1430cEf08126";
  const token="0x78cf24370174180738c5b8e352b6d14c83a6c9a9";
  const dstEid=40374;
  let provider,signer,me;

  async function connect(){
    try{
      if(!window.ethereum)throw new Error("Buka MetaMask/OKX");
      provider=new ethers.providers.Web3Provider(window.ethereum,"any");
      await provider.send("eth_requestAccounts",[]);
      signer=provider.getSigner();me=await signer.getAddress();
      log(`âœ… Connected: ${me}`);document.getElementById("approve").disabled=false;document.getElementById("bridge").disabled=false;
    }catch(e){log("âŒ Connect error: "+(e.message||e));}
  }

  async function approve(){
    try{
      const amountStr=document.getElementById("amount").value.trim();
      if(!amountStr)return log("âš ï¸ Masukkan jumlah token.");
      const amount=ethers.utils.parseUnits(amountStr,"6");
      const erc20=new ethers.Contract(token,ERC20_ABI,signer);
      log("ğŸ§¾ Approving...");
      const tx=await erc20.approve(adapter,amount);
      log(`â³ TX: ${tx.hash}`);await tx.wait();log("âœ… Approve sukses!");
    }catch(e){log("âŒ Approve error: "+(e.message||e));}
  }

  async function bridgeNow(){
    try{
      const amountStr=document.getElementById("amount").value.trim();
      if(!amountStr)return log("âš ï¸ Masukkan jumlah token.");
      const amountLD=ethers.utils.parseUnits(amountStr,"6");
      const to32="0x"+me.replace(/^0x/,"").padStart(64,"0");
      const oft=new ethers.Contract(adapter,OFT_ABI,signer);
      const sendParam=[dstEid,to32,amountLD,amountLD,"0x","0x","0x"];
      const fee=await oft.quoteSend(sendParam,false);
      const nativeFee=ethers.BigNumber.isBigNumber(fee[0])?fee[0]:ethers.BigNumber.from(fee.nativeFee);
      const tx=await oft.send(sendParam,[nativeFee,0],me,{value:nativeFee,gasLimit:350000});
      log(`â³ TX: ${tx.hash}`);await tx.wait();log("âœ… Bridge sukses ğŸ‰");
    }catch(e){log("âŒ Bridge error: "+(e.message||e));}
  }

  document.getElementById("connectBridge").onclick=connect;
  document.getElementById("approve").onclick=approve;
  document.getElementById("bridge").onclick=bridgeNow;
}

/* REDEEM */
const logR=m=>{const el=document.getElementById("logRedeem");el.textContent+=(el.textContent?"\n":"")+m;el.scrollTop=el.scrollHeight;}
const LZ_ABI=["function lzReceive(uint32,bytes32,bytes,address) external"];
let providerR,signerR,meR;

async function connectRedeem(){
  try{
    providerR=new ethers.providers.Web3Provider(window.ethereum,"any");
    await providerR.send("eth_requestAccounts",[]);
    signerR=providerR.getSigner();meR=await signerR.getAddress();
    const n=await providerR.getNetwork();
    logR(`âœ… Connected: ${meR}\nChain: ${n.chainId}`);
  }catch(e){logR("âŒ Connect error: "+(e.message||e));}
}

async function redeem(){
  try{
    const srcEid=Number(document.getElementById("srcEid").value.trim());
    const sender=document.getElementById("sender32").value.trim();
    const payload=document.getElementById("payload").value.trim();
    const execRaw=document.getElementById("executor").value.trim().replace(/\s+/g,"");
    const exec=ethers.utils.getAddress(execRaw);
    if(!/^0x[0-9a-fA-F]{64}$/.test(sender))return logR("âš ï¸ sender32 harus 32-byte hex.");
    if(!/^0x[0-9a-fA-F]+$/.test(payload))return logR("âš ï¸ payload harus hex 0xâ€¦");
    const c=new ethers.Contract(exec,LZ_ABI,signerR);
    logR(`ğŸš€ Executor valid: ${exec}`);
    const tx=await c.lzReceive(srcEid,sender,payload,exec,{gasLimit:600000});
    logR(`â³ TX: ${tx.hash}`);const rc=await tx.wait();
    logR(`âœ… Delivered at block ${rc.blockNumber}`);
  }catch(e){logR("âŒ Redeem error: "+(e.data?.message||e.message));}
}

document.getElementById("connectRedeem").onclick=connectRedeem;
document.getElementById("redeem").onclick=redeem;
</script>
</body>
</html>
