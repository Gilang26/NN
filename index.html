<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LayerZero Redeem (Final Offline Fix)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
body {
  font-family: "Poppins", sans-serif;
  background: #f6fff8;
  color: #111;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  margin: 0;
}
.card {
  background: #fff;
  border: 1px solid #c8e3ce;
  border-radius: 16px;
  padding: 24px;
  width: min(480px, 90vw);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}
h2 {
  color: #22c55e;
  text-align: center;
  margin-top: 0;
}
input, button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 10px;
  font-size: 15px;
}
input {
  border: 1px solid #b9e1c2;
  background: #ecf8ed;
  color: #111;
}
button {
  cursor: pointer;
  font-weight: 700;
  border: 0;
  transition: 0.2s;
}
button.primary {
  background: linear-gradient(90deg,#34d058,#22c55e);
  color: #fff;
}
pre {
  background: #ecf8ed;
  border: 1px solid #b9e1c2;
  border-radius: 10px;
  padding: 10px;
  margin-top: 14px;
  font-size: 13px;
  white-space: pre-wrap;
  max-height: 300px;
  overflow: auto;
}
footer {margin-top:25px;color:#666;font-size:14px;}
</style>
</head>
<body>
<div class="card">
  <h2>üîÅ LayerZero Redeem (Final)</h2>
  <input id="executor" value="0xab329959fe048721cdf7f13a3eb43e4fc549a9de1adb90d393701583c4b11f79" placeholder="Executor" />
  <input id="amount" value="10" placeholder="Jumlah token (default 10)" />
  <button id="connect" class="primary">üîå Connect Wallet</button>
  <button id="build" class="primary">üß± Build sender32 + payload</button>
  <button id="redeem" class="primary">üöÄ Redeem Sekarang</button>
  <pre id="log">log siap...</pre>
</div>
<footer>by thdx</footer>

<script>
const log = m=>{const el=document.getElementById("log");el.textContent+=(el.textContent?"\n":"")+m;el.scrollTop=el.scrollHeight;console.log(m);}
const LZ_ABI4=["function lzReceive(uint32,bytes32,bytes,address) external"];
const LZ_ABI3=["function lzReceive(uint32,bytes32,bytes) external"];
let provider,signer,me;
const SRC_EID=30101; // Sepolia -> Stable
const toBytes32=a=>"0x"+a.replace(/^0x/,"").padStart(64,"0");
const buildPayload=(to,amt)=>ethers.utils.defaultAbiCoder.encode(
  ["address","uint256"],[ethers.utils.getAddress(to),ethers.utils.parseUnits(String(amt),"6")]
);

async function connect(){
  try{
    provider=new ethers.providers.Web3Provider(window.ethereum,"any");
    await provider.send("eth_requestAccounts",[]);
    signer=provider.getSigner();
    me=await signer.getAddress();
    const n=await provider.getNetwork();
    log(`‚úÖ Connected: ${me}\nChain: ${n.chainId}`);
  }catch(e){log("‚ùå Connect error: "+(e.message||e));}
}

async function buildAuto(){
  try{
    if(!me)return log("‚ö†Ô∏è Hubungkan wallet dulu.");
    const amt=document.getElementById("amount").value.trim()||"10";
    const sender32=toBytes32(me);
    const payload=buildPayload(me,amt);
    window.sender32=sender32;
    window.payload=payload;
    log(`‚úÖ Auto built sender32 & payload`);
    log(`üë§ sender32: ${sender32}`);
    log(`üì¶ payload: ${payload.slice(0,66)}...`);
  }catch(e){log("‚ùå Build error: "+(e.message||e));}
}

async function redeemNow(){
  try{
    if(!window.sender32||!window.payload)return log("‚ö†Ô∏è Build dulu sebelum redeem.");
    const exec=document.getElementById("executor").value.trim();
    const c4=new ethers.Contract(exec,LZ_ABI4,signer);
    const c3=new ethers.Contract(exec,LZ_ABI3,signer);
    try{
      log(`üöÄ Coba lzReceive v4 @ ${exec}`);
      const tx=await c4.lzReceive(SRC_EID,window.sender32,window.payload,exec,{gasLimit:600000});
      log(`‚è≥ TX: ${tx.hash}`);
      const rc=await tx.wait();
      log(`‚úÖ Redeem sukses di block ${rc.blockNumber}`);
    }catch(err1){
      log("‚ö†Ô∏è Versi v4 gagal, coba v3...");
      const tx2=await c3.lzReceive(SRC_EID,window.sender32,window.payload,{gasLimit:600000});
      log(`‚è≥ TX: ${tx2.hash}`);
      const rc2=await tx2.wait();
      log(`‚úÖ Redeem v3 sukses di block ${rc2.blockNumber}`);
    }
  }catch(e){log("‚ùå Redeem error: "+(e.data?.message||e.message||e));}
}

document.getElementById("connect").onclick=connect;
document.getElementById("build").onclick=buildAuto;
document.getElementById("redeem").onclick=redeemNow;
</script>
</body>
</html>
